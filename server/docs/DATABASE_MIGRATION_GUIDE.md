# ä¼ä¸šçº§æ•°æ®åº“ç®¡ç†æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### 1. æ•°æ®ä¸¢å¤±çš„æ ¹æœ¬åŸå› 

åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œæ•°æ®ä¸¢å¤±çš„ä¸»è¦åŸå› æ˜¯ï¼š

- **ä½¿ç”¨äº† `prisma db push` è€Œé `prisma migrate`**
  - `db push` ç›´æ¥åŒæ­¥ schema åˆ°æ•°æ®åº“ï¼Œä¸ä¿ç•™å†å²
  - å½“ schema æ”¹å˜æ—¶ï¼ŒPrisma å¯èƒ½ä¼š DROP è¡¨å¹¶é‡å»º
  - **ç»“æœï¼šæ‰€æœ‰æ•°æ®ä¸¢å¤±**

- **æ­£ç¡®çš„åšæ³•**
  - ä½¿ç”¨ `prisma migrate dev` åˆ›å»º migration
  - ä½¿ç”¨ `prisma migrate deploy` éƒ¨ç½²åˆ°ç”Ÿäº§
  - **Prisma ä¼šä¿ç•™ migration å†å²ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±**

### 2. å¤‡ä»½æœåŠ¡çš„é—®é¢˜

åŸæœ‰å¤‡ä»½æœåŠ¡çš„é—®é¢˜ï¼š

- ç¡¬ç¼–ç è¡¨åï¼Œå®¹æ˜“é—æ¼æ–°è¡¨ï¼ˆå¦‚ `Memory`ï¼‰
- æ²¡æœ‰å¤‡ä»½å…ƒæ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯
- æ²¡æœ‰å¤‡ä»½æŠ¥å‘Šï¼Œä¸çŸ¥é“å¤‡ä»½äº†ä»€ä¹ˆ
- æ¢å¤æ—¶ç¼ºå°‘éªŒè¯æœºåˆ¶

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›

1. **Migration ç®¡ç†æœåŠ¡** (`migration.service.js`)
   - è‡ªåŠ¨åœ¨ migration å‰å¤‡ä»½
   - è®°å½• migration å†å²
   - æ”¯æŒå®‰å…¨å›æ»š

2. **å¢å¼ºçš„å¤‡ä»½æœåŠ¡** (`backup.service.js`)
   - è‡ªåŠ¨å‘ç°æ‰€æœ‰è¡¨
   - ç”Ÿæˆå¤‡ä»½æŠ¥å‘Š
   - åŒ…å«å…ƒæ•°æ®

3. **CLI ç®¡ç†å·¥å…·** (`migrate-cli.js`)
   - ç»Ÿä¸€çš„å‘½ä»¤è¡Œæ¥å£
   - äººæ€§åŒ–çš„äº¤äº’
   - å®Œæ•´çš„å†å²è¿½è¸ª

## ä½¿ç”¨æ–¹æ³•

### 1. å®‰è£…ä¾èµ–

```bash
cd server
npm install commander
```

### 2. æ·»åŠ  npm scripts

åœ¨ `server/package.json` ä¸­æ·»åŠ ï¼š

```json
{
  "scripts": {
    "db:migrate": "node migrate-cli.js create",
    "db:deploy": "node migrate-cli.js deploy",
    "db:history": "node migrate-cli.js history",
    "db:rollback": "node migrate-cli.js rollback",
    "db:backups": "node migrate-cli.js backups"
  }
}
```

### 3. ä¿®æ”¹è¡¨ç»“æ„çš„æ­£ç¡®æµç¨‹

#### å¼€å‘ç¯å¢ƒ

```bash
# 1. ä¿®æ”¹ prisma/schema.prisma

# 2. åˆ›å»º migrationï¼ˆä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰
npm run db:migrate add_new_field

# 3. æŸ¥çœ‹ migration å†å²
npm run db:history

# 4. å¦‚æœæœ‰é—®é¢˜ï¼Œå›æ»š
npm run db:backups  # æŸ¥çœ‹å¯ç”¨å¤‡ä»½
npm run db:rollback prisma-backup-20251215120000.json
```

#### ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. éƒ¨ç½² migrationï¼ˆä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰
npm run db:deploy

# 2. éªŒè¯æ•°æ®
npm run db:history
```

### 4. å‘½ä»¤è¯¦è§£

#### åˆ›å»º Migration

```bash
npm run db:migrate <migration-name>

# ä¾‹å¦‚ï¼š
npm run db:migrate add_user_avatar
npm run db:migrate update_post_schema
```

**æµç¨‹ï¼š**
1. è‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®åº“
2. æ£€æµ‹ schema å˜æ›´
3. åˆ›å»º migration æ–‡ä»¶
4. åº”ç”¨åˆ°æ•°æ®åº“
5. è®°å½•æ‰§è¡Œå†å²

#### éƒ¨ç½²åˆ°ç”Ÿäº§

```bash
npm run db:deploy
```

**æµç¨‹ï¼š**
1. è‡ªåŠ¨å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
2. åº”ç”¨æ‰€æœ‰å¾…æ‰§è¡Œçš„ migration
3. è®°å½•æ‰§è¡Œç»“æœ

#### æŸ¥çœ‹å†å²

```bash
npm run db:history
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“‹ Migration å†å²è®°å½•:

================================================================================
âœ… add_user_avatar
  æ—¶é—´: 2025/12/15 12:00:00
  å¤‡ä»½: prisma-backup-20251215120000.json
--------------------------------------------------------------------------------
âœ… update_post_schema
  æ—¶é—´: 2025/12/15 11:00:00
  å¤‡ä»½: prisma-backup-20251215110000.json
--------------------------------------------------------------------------------
```

#### æŸ¥çœ‹å¤‡ä»½

```bash
npm run db:backups
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“¦ å¯ç”¨å¤‡ä»½åˆ—è¡¨:

================================================================================
ğŸ“ prisma-backup-20251215120000.json
  ç±»å‹: prisma
  å¤§å°: 2.45 MB
  æ—¶é—´: 2025/12/15 12:00:00
--------------------------------------------------------------------------------
```

#### å›æ»šæ•°æ®åº“

```bash
npm run db:rollback <backup-file>

# ä¾‹å¦‚ï¼š
npm run db:rollback prisma-backup-20251215120000.json
```

**æµç¨‹ï¼š**
1. æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
2. è¦æ±‚ç¡®è®¤ï¼ˆè¾“å…¥ yes/noï¼‰
3. æ¢å¤æ•°æ®åº“åˆ°å¤‡ä»½çŠ¶æ€

## å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯ 1ï¼šæ·»åŠ æ–°å­—æ®µ

```bash
# 1. ä¿®æ”¹ schema.prisma
# model User {
#   id       Int       @id @default(autoincrement())
#   username String    @unique
#   avatar   String?   // æ–°å¢å­—æ®µ
#   ...
# }

# 2. åˆ›å»º migration
npm run db:migrate add_user_avatar

# è¾“å‡ºï¼š
# ğŸ”’ æ‰§è¡Œ Migration å‰è‡ªåŠ¨å¤‡ä»½...
# âœ… å¤‡ä»½å®Œæˆ: prisma-backup-20251215120000.json
# ğŸ“‹ æ£€æŸ¥ Schema å˜æ›´...
# ğŸš€ åˆ›å»º Migration: add_user_avatar
# âœ… Migration åˆ›å»ºæˆåŠŸ
```

### åœºæ™¯ 2ï¼šMigration å¤±è´¥éœ€è¦å›æ»š

```bash
# 1. Migration å¤±è´¥
npm run db:migrate problematic_change

# è¾“å‡ºï¼š
# ğŸ”’ æ‰§è¡Œ Migration å‰è‡ªåŠ¨å¤‡ä»½...
# âœ… å¤‡ä»½å®Œæˆ: prisma-backup-20251215130000.json
# âŒ Migration å¤±è´¥!
# ğŸ’¡ å¯ä»¥ä½¿ç”¨å¤‡ä»½æ–‡ä»¶å›æ»š: prisma-backup-20251215130000.json

# 2. å›æ»šåˆ°å¤‡ä»½
npm run db:rollback prisma-backup-20251215130000.json

# 3. ä¿®å¤ schema.prisma åé‡æ–°å°è¯•
npm run db:migrate fixed_change
```

### åœºæ™¯ 3ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•é€šè¿‡åï¼Œæäº¤ä»£ç 
git add .
git commit -m "feat: add user avatar field"
git push

# 2. åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Š
git pull
cd server
npm install

# 3. éƒ¨ç½² migration
npm run db:deploy

# è¾“å‡ºï¼š
# ğŸ”’ æ‰§è¡Œ Migration å‰è‡ªåŠ¨å¤‡ä»½...
# âœ… å¤‡ä»½å®Œæˆ: prisma-backup-20251215140000.json
# ğŸš€ éƒ¨ç½² Migration åˆ°ç”Ÿäº§ç¯å¢ƒ...
# âœ… Migration éƒ¨ç½²æˆåŠŸ!
```

## å¤‡ä»½æ–‡ä»¶ç»“æ„

å¤‡ä»½æ–‡ä»¶åŒ…å«å®Œæ•´çš„æ•°æ®å’Œå…ƒæ•°æ®ï¼š

```json
{
  "_metadata": {
    "timestamp": "2025-12-15T12:00:00.000Z",
    "version": "2.0",
    "tables": 18,
    "environment": "development",
    "totalRecords": 1234
  },
  "user": [
    { "id": 1, "username": "admin", ... }
  ],
  "post": [
    { "id": 1, "title": "Hello", ... }
  ],
  ...
}
```

## æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦è§„åˆ™

1. **æ°¸è¿œä¸è¦ä½¿ç”¨ `prisma db push` ä¿®æ”¹ç”Ÿäº§æ•°æ®åº“**
   - ä»…åœ¨åŸå‹å¼€å‘æ—¶ä½¿ç”¨
   - æ­£å¼å¼€å‘å¿…é¡»ä½¿ç”¨ `prisma migrate`

2. **æ¯æ¬¡ä¿®æ”¹ schema å‰ç¡®è®¤**
   - ç†è§£å˜æ›´çš„å½±å“
   - æ£€æŸ¥æ˜¯å¦éœ€è¦æ•°æ®è¿ç§»è„šæœ¬
   - æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

3. **å®šæœŸå¤‡ä»½**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨æ¯å¤©å¤‡ä»½
   - é‡è¦æ“ä½œå‰æ‰‹åŠ¨å¤‡ä»½
   - ä¿ç•™è¶³å¤Ÿçš„å¤‡ä»½å†å²

4. **ç”Ÿäº§ç¯å¢ƒè°¨æ…**
   - å…ˆåœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒéªŒè¯
   - é€‰æ‹©ä½å³°æœŸæ‰§è¡Œ
   - å‡†å¤‡å›æ»šæ–¹æ¡ˆ

### ğŸ“ æœ€ä½³å®è·µ

1. **Migration å‘½åè§„èŒƒ**
   - ä½¿ç”¨æè¿°æ€§åç§°ï¼š`add_user_avatar`
   - ä½¿ç”¨åŠ¨è¯å¼€å¤´ï¼š`add_`, `update_`, `remove_`
   - ç®€æ´æ˜äº†

2. **å¤‡ä»½ä¿ç•™ç­–ç•¥**
   - é»˜è®¤ä¿ç•™ 7 å¤©
   - é‡è¦ migration çš„å¤‡ä»½æ°¸ä¹…ä¿ç•™
   - å®šæœŸæ¸…ç†æ—§å¤‡ä»½

3. **å›¢é˜Ÿåä½œ**
   - migration æ–‡ä»¶æäº¤åˆ° git
   - ä¸è¦åˆ é™¤å·²éƒ¨ç½²çš„ migration
   - æ–° migration è§£å†³å†²çª

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šMigration å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âŒ Migration å¤±è´¥!
  é”™è¯¯: ...
```

**è§£å†³ï¼š**
1. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ schema.prisma è¯­æ³•
3. ä½¿ç”¨ `npm run db:rollback` å›æ»š
4. ä¿®å¤åé‡è¯•

### é—®é¢˜ 2ï¼šæ•°æ®ä¸¢å¤±

**ç—‡çŠ¶ï¼š**
æ•°æ®åº“è¡¨ä¸ºç©ºæˆ–æ•°æ®ç¼ºå¤±

**è§£å†³ï¼š**
1. `npm run db:backups` æŸ¥çœ‹å¯ç”¨å¤‡ä»½
2. `npm run db:history` æŸ¥çœ‹æœ€è¿‘çš„ migration
3. `npm run db:rollback` æ¢å¤åˆ°æœ€è¿‘çš„å¤‡ä»½

### é—®é¢˜ 3ï¼šå¤‡ä»½æ–‡ä»¶æŸå

**ç—‡çŠ¶ï¼š**
```
âŒ å›æ»šå¤±è´¥!
  é”™è¯¯: JSON parse error
```

**è§£å†³ï¼š**
1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
2. ä½¿ç”¨æ›´æ—©çš„å¤‡ä»½
3. å¦‚æœæœ‰æ•°æ®åº“å¿«ç…§ï¼Œä½¿ç”¨æ•°æ®åº“çº§åˆ«æ¢å¤

## ç›‘æ§å’Œå‘Šè­¦

### è‡ªåŠ¨ç›‘æ§

ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ï¼š
- æ¯æ¬¡ migration çš„æ‰§è¡Œç»“æœ
- å¤‡ä»½æ–‡ä»¶çš„å¤§å°å’Œå®Œæ•´æ€§
- å¤±è´¥çš„ migration å’Œé”™è¯¯ä¿¡æ¯

### å»ºè®®æ·»åŠ å‘Šè­¦

```javascript
// åœ¨ migration.service.js ä¸­æ·»åŠ 
const sendAlert = async (type, message) => {
  // å‘é€é‚®ä»¶/çŸ­ä¿¡/é’‰é’‰é€šçŸ¥
  // ä¾‹å¦‚ï¼šawait sendEmail(admin, `Migration ${type}: ${message}`)
}
```

## æ€»ç»“

è¿™å¥—æ–¹æ¡ˆæä¾›äº†ï¼š

âœ… **æ•°æ®å®‰å…¨**
- è‡ªåŠ¨å¤‡ä»½æœºåˆ¶
- å®Œæ•´çš„å›æ»šèƒ½åŠ›
- Migration å†å²è¿½è¸ª

âœ… **æ“ä½œç®€å•**
- ç»Ÿä¸€çš„ CLI æ¥å£
- æ¸…æ™°çš„æç¤ºä¿¡æ¯
- äººæ€§åŒ–çš„äº¤äº’

âœ… **ä¼ä¸šçº§**
- å®Œæ•´çš„å…ƒæ•°æ®è®°å½•
- å¤‡ä»½æŠ¥å‘Šç”Ÿæˆ
- ç”Ÿäº§ç¯å¢ƒä¿æŠ¤

ä½¿ç”¨è¿™å¥—æ–¹æ¡ˆï¼Œä½ å°†å½»åº•å‘Šåˆ«æ•°æ®ä¸¢å¤±çš„çƒ¦æ¼ï¼
